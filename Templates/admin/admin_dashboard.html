{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard Administrativo{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="bg-light min-vh-100 py-4">
    <div class="container-fluid px-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h3 fw-bold text-secondary">Dashboard Executivo</h2>
            <a href="{% url 'admin_reports' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-file-alt me-2"></i> Relat√≥rios Completos
            </a>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100 border-start border-primary border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-uppercase text-muted small fw-bold mb-1">Faturamento Total</p>
                                <h4 class="fw-bold text-primary mb-0">R$ {{ total_revenue|intcomma }}</h4>
                            </div>
                            <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle">
                                <i class="fas fa-dollar-sign fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100 border-start border-success border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-uppercase text-muted small fw-bold mb-1">Total Pedidos</p>
                                <h4 class="fw-bold text-success mb-0">{{ total_orders }}</h4>
                            </div>
                            <div class="bg-success bg-opacity-10 text-success p-3 rounded-circle">
                                <i class="fas fa-shopping-bag fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100 border-start border-info border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-uppercase text-muted small fw-bold mb-1">Ticket M√©dio</p>
                                <h4 class="fw-bold text-info mb-0">R$ {{ avg_ticket|floatformat:2 }}</h4>
                            </div>
                            <div class="bg-info bg-opacity-10 text-info p-3 rounded-circle">
                                <i class="fas fa-chart-line fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100 border-start border-warning border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-uppercase text-muted small fw-bold mb-1">Clientes Ativos</p>
                                <h4 class="fw-bold text-warning mb-0">{{ total_clients }}</h4>
                            </div>
                            <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-circle">
                                <i class="fas fa-users fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-area me-2"></i> Evolu√ß√£o de Faturamento (6 Meses)</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-pie me-2"></i> Status dos Pedidos</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-dark">üèÜ Top 5 Produtos Mais Vendidos</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="bg-light small text-uppercase">
                                    <tr>
                                        <th class="ps-4">Produto</th>
                                        <th class="text-end pe-4">Qtd. Vendida</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in top_products %}
                                    <tr>
                                        <td class="ps-4 fw-bold text-secondary">{{ item.product__name }}</td>
                                        <td class="text-end pe-4">
                                            <span class="badge bg-primary rounded-pill px-3">{{ item.total_qty }}</span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="2" class="text-center py-3">Sem dados suficientes.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom border-danger border-2">
                        <h6 class="m-0 fw-bold text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Alerta de Estoque Baixo</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="bg-light small text-uppercase">
                                    <tr>
                                        <th class="ps-4">Produto</th>
                                        <th class="text-center">Atual</th>
                                        <th class="text-center">A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prod in low_stock %}
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                {% if prod.main_image %}
                                                <img src="{{ prod.main_image.url }}" class="rounded me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                                {% endif %}
                                                <span class="text-dark fw-bold">{{ prod.name }}</span>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-danger text-white">{{ prod.stock_quantity }} un</span>
                                        </td>
                                        <td class="text-center">
                                            <a href="#" class="btn btn-sm btn-outline-dark"><i class="fas fa-plus"></i> Repor</a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center py-3 text-success"><i class="fas fa-check-circle me-2"></i> Estoque saud√°vel!</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Configura√ß√£o do Gr√°fico de Vendas (Linha)
    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctxRevenue, {
        type: 'line',
        data: {
            labels: {{ revenue_chart_labels|safe }}, // Dados vindos do Django
            datasets: [{
                label: 'Faturamento (R$)',
                data: {{ revenue_chart_data|safe }}, // Dados vindos do Django
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                pointRadius: 3,
                pointBackgroundColor: '#4e73df',
                pointBorderColor: '#4e73df',
                pointHoverRadius: 5,
                tension: 0.3, // Curva suave
                fill: true
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { borderDash: [2] }, beginAtZero: true },
                x: { grid: { display: false } }
            }
        }
    });

    // Configura√ß√£o do Gr√°fico de Status (Doughnut)
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: {{ status_pie_labels|safe }},
            datasets: [{
                data: {{ status_pie_data|safe }},
                backgroundColor: ['#f6c23e', '#1cc88a', '#36b9cc', '#e74a3b', '#858796'],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            cutout: '70%',
        },
    });
</script>
{% endblock %}