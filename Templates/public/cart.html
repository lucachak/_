{% extends 'base.html' %}
{% load humanize %}

{% block title %}Carrinho | EletricBike{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="fw-bold text-white mb-4"><i class="fas fa-shopping-cart text-primary me-2"></i> Seu Carrinho</h2>

    {% if cart.items.exists %}
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="bg-glass rounded-4 overflow-hidden border border-light border-opacity-10">
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle mb-0" style="background: transparent;">
                        <thead>
                            <tr class="text-uppercase text-muted small border-bottom border-light border-opacity-10">
                                <th class="ps-4 py-3 border-0">Produto</th>
                                <th class="text-center border-0">Qtd</th>
                                <th class="text-end border-0">Preço</th>
                                <th class="text-center border-0"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cart.items.all %}
                            <tr>
                                <td class="ps-4 py-3 border-light border-opacity-10">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-white rounded-3 overflow-hidden" style="width: 60px; height: 60px;">
                                            {% if item.product.main_image %}
                                                <img src="{{ item.product.main_image.url }}" class="w-100 h-100 object-fit-cover" alt="{{ item.product.name }}">
                                            {% else %}
                                                <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-secondary"><i class="fas fa-bicycle text-white"></i></div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <a href="#" class="fw-bold text-white text-decoration-none">{{ item.product.name }}</a>
                                            <small class="d-block text-muted">{{ item.product.sku }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center border-light border-opacity-10">
                                    <span class="badge bg-dark border border-light border-opacity-25 px-3 py-2">{{ item.quantity }}</span>
                                </td>
                                <td class="text-end fw-bold text-primary border-light border-opacity-10">
                                    R$ {{ item.subtotal|intcomma }}
                                </td>
                                <td class="text-center border-light border-opacity-10">
                                    <a href="{% url 'cart_remove' item.product.id %}" class="text-danger hover-opacity-75"><i class="fas fa-trash"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mt-4">
                <a href="{% url 'bike_catalog' %}" class="text-muted text-decoration-none small fw-bold hover-text-white">
                    <i class="fas fa-arrow-left me-2"></i> Continuar Comprando
                </a>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="bg-glass rounded-4 p-4 border border-light border-opacity-10 sticky-top" style="top: 100px;">
                <h5 class="fw-bold text-white mb-4">Resumo do Pedido</h5>
                
                <form action="{% url 'coupon_apply' %}" method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" name="code" value="{{ cart.coupon.code|default:'' }}" class="form-control form-control-dark" placeholder="CUPOM" style="text-transform: uppercase;">
                        <button class="btn btn-outline-light" type="submit">Aplicar</button>
                    </div>
                </form>

                <div class="d-flex justify-content-between mb-2 text-muted">
                    <span>Subtotal</span>
                    <span>R$ {{ cart.total_amount|intcomma }}</span>
                </div>

                {% if cart.coupon %}
                <div class="d-flex justify-content-between mb-2 text-success">
                    <span>Desconto ({{ cart.coupon.code }})</span>
                    <span>- R$ {{ cart.discount_amount|intcomma }}</span>
                </div>
                {% endif %}

                <hr class="border-light opacity-10 my-3">

                <div class="d-flex justify-content-between mb-4">
                    <span class="fs-5 fw-bold text-white">Total</span>
                    <span class="fs-4 fw-bold text-primary">R$ {{ cart.total_with_discount|intcomma }}</span>
                </div>

                <a href="{% url 'checkout_create_order' %}" class="btn btn-neon w-100 py-3 fw-bold">
                    Finalizar Compra <i class="fas fa-check ms-2"></i>
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="mb-4 opacity-25">
            <i class="fas fa-shopping-basket fa-4x text-white"></i>
        </div>
        <h3 class="text-white">Seu carrinho está vazio</h3>
        <p class="text-muted mb-4">Confira nossos kits de conversão e transforme sua bike hoje.</p>
        <a href="{% url 'bike_catalog' %}" class="btn btn-neon px-5">Ver Catálogo</a>
    </div>
    {% endif %}
</div>
{% endblock %}